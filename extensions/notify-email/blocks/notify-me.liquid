{% if product.selected_or_first_available_variant.available == false %}
<style>
.product-form__buttons, .shopify-payment-button { display:none !important; }
#bis-btn { width:100%; padding:15px; background:black; color:white; cursor:pointer; border:none; border-radius: 5px; font-size: 16px; }
#bis-modal { margin-top: 15px; padding: 20px; background: #f9f9f9; border-radius: 5px; }
</style>

<button id="bis-btn">üîî Notify me when available</button>

<div id="bis-modal" style="display:none;">
  <input type="email" id="bis-email" placeholder="Enter your email" style="width:100%;padding:12px;margin-bottom:10px;border:1px solid #ddd;border-radius:5px;">
  <button id="bis-submit" style="width:100%;padding:12px;background:#28a745;color:white;border:none;cursor:pointer;border-radius:5px;font-weight:bold;">Subscribe</button>
  <p id="bis-message" style="margin-top:10px;font-size:14px;"></p>
</div>

<script>
(function() {
  const btn = document.getElementById("bis-btn");
  const modal = document.getElementById("bis-modal");
  const submitBtn = document.getElementById("bis-submit");
  const emailInput = document.getElementById("bis-email");
  const message = document.getElementById("bis-message");

  btn.onclick = () => {
    modal.style.display = "block";
  };

  submitBtn.onclick = async () => {
    const email = emailInput.value.trim();
    
    if (!email || !email.includes("@")) {
      message.textContent = "‚ùå Please enter a valid email";
      message.style.color = "red";
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = "Subscribing...";
    message.textContent = "";

    try {
      const variantId = "{{ product.selected_or_first_available_variant.id }}".replace('gid://shopify/ProductVariant/', '');
      const shop = "{{ shop.permanent_domain }}";
      const productName = "{{ product.title | escape }}";

      console.log("Sending:", { email, variantId, shop, productName });

      const res = await fetch("/apps/notify-out-stock/subscribe", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          email: email,
          variantId: variantId,
          shop: shop,
          productName: productName
        })
      });

      const text = await res.text();
      console.log("Response:", text);
      
      const data = text ? JSON.parse(text) : {};

      if (data.success) {
        message.textContent = "‚úì Subscribed! We'll email you when it's back in stock.";
        message.style.color = "green";
        emailInput.value = "";
        setTimeout(() => { 
          modal.style.display = "none"; 
          message.textContent = "";
        }, 3000);
      } else {
        message.textContent = "‚ùå " + (data.error || "Something went wrong");
        message.style.color = "red";
      }
    } catch (err) {
      console.error("Error:", err);
      message.textContent = "‚ùå Network error. Please try again.";
      message.style.color = "red";
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "Subscribe";
    }
  };
})();
</script>
{% endif %}

{% schema %}
{
  "name": "Notify Me",
  "target": "section"
}
{% endschema %}