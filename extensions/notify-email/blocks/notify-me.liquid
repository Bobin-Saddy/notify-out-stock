{% comment %}
  Shows notify button when OUT OF STOCK and wishlist button when IN STOCK
{% endcomment %}

<style>
.product-form__buttons, .shopify-payment-button { display:none !important; }

/* Overlay */
#bis-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  backdrop-filter: blur(4px);
  display: none;
  z-index: 9998;
}

/* Modal */
#bis-modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.95);
  width: 100%;
  max-width: 420px;
  background: {{ block.settings.popup_bg_color }};
  color: {{ block.settings.popup_text_color }};
  border-radius: 16px;
  padding: 24px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.25);
  z-index: 9999;
  display: none;
  animation: bisPop 0.25s ease forwards;
  font-family: {{ block.settings.popup_font }};
}

@keyframes bisPop {
  from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
  to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
}

/* Header */
#bis-modal h3 {
  margin: 0 0 8px;
  font-size: 22px;
  font-weight: 700;
  text-align: center;
}

/* Subheader */
#bis-modal p.subtitle {
  margin: 0 0 20px;
  text-align: center;
  opacity: 0.8;
  font-size: 14px;
}

/* Close */
#bis-close {
  position: absolute;
  top: 12px;
  right: 14px;
  border: none;
  background: none;
  font-size: 20px;
  cursor: pointer;
  color: {{ block.settings.popup_text_color }};
}

/* Input */
#bis-email {
  width: 100%;
  padding: 14px;
  border-radius: 10px;
  border: 1px solid #ddd;
  font-size: 15px;
  margin-bottom: 14px;
}

/* Subscribe Button */
#bis-submit {
  width: 100%;
  padding: 14px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  font-size: 16px;
  font-weight: 700;
  color: #fff;
  background: linear-gradient(135deg, #667eea, #764ba2);
  transition: 0.3s;
}

#bis-submit:hover {
  opacity: 0.9;
  transform: translateY(-1px);
}

#bis-submit:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

/* Message */
#bis-message {
  margin-top: 12px;
  text-align: center;
  font-size: 14px;
}

#bis-message.success {
  color: #10b981;
}

#bis-message.error {
  color: #ef4444;
}

/* Main Buttons */
#bis-btn, #wishlist-btn { 
  width:100%; 
  padding:16px; 
  color:white; 
  cursor:pointer; 
  border:none; 
  border-radius: 10px; 
  font-size: 16px; 
  font-weight: bold;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

#bis-btn {
  background: linear-gradient(135deg, #111, #333);
}

#wishlist-btn {
  background: linear-gradient(135deg, #ec4899, #ef4444);
}

#wishlist-btn.in-wishlist {
  background: linear-gradient(135deg, #10b981, #059669);
}

#bis-btn:hover, #wishlist-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
</style>

<!-- Out of Stock: Show Notify Button -->
{% if product.selected_or_first_available_variant.available == false %}
  <button id="bis-btn">
    üîî {{ block.settings.button_text | default: 'Notify me when available' }}
  </button>
{% else %}
  <!-- In Stock: Show Wishlist Button -->
  <button id="wishlist-btn" data-in-wishlist="false">
    <span class="wishlist-icon">‚ù§Ô∏è</span>
    <span class="wishlist-text">Add to Wishlist</span>
  </button>
{% endif %}

<div id="bis-overlay"></div>

<!-- Notify Me Modal -->
<div id="bis-modal">
  <button id="bis-close">‚úï</button>
  <h3>{{ block.settings.headertext }}</h3>
  <p class="subtitle">{{ block.settings.subheadertext }}</p>
  <input 
    type="email" 
    id="bis-email" 
    placeholder="{{ block.settings.email_placeholder | default: 'Enter your email' }}" 
    required
  >
  <button id="bis-submit">
    {{ block.settings.subscribe_text | default: 'Notify Me' }}
  </button>
  <p id="bis-message"></p>
</div>

<script>
(function() {
  const bisBtn = document.getElementById("bis-btn");
  const wishlistBtn = document.getElementById("wishlist-btn");
  const modal = document.getElementById("bis-modal");
  const overlay = document.getElementById("bis-overlay");
  const closeBtn = document.getElementById("bis-close");
  const submitBtn = document.getElementById("bis-submit");
  const emailInput = document.getElementById("bis-email");
  const messageEl = document.getElementById("bis-message");

  const shop = "{{ shop.permanent_domain }}";
  const productId = {{ product.id | json }};
  const productTitle = {{ product.title | json }};
  const productImage = {{ product.featured_image | img_url: 'medium' | json }};
  const productHandle = {{ product.handle | json }};

  function getCurrentVariant() {
    return {{ product.selected_or_first_available_variant | json }};
  }

  function closeModal() {
    modal.style.display = "none";
    overlay.style.display = "none";
    messageEl.textContent = "";
    messageEl.className = "";
  }

  function showMessage(text, isError = false) {
    messageEl.textContent = text;
    messageEl.className = isError ? "error" : "success";
  }

  // ========== NOTIFY ME FUNCTIONALITY ==========
  if (bisBtn) {
    bisBtn.onclick = () => {
      modal.style.display = "block";
      overlay.style.display = "block";
      emailInput.value = "";
      messageEl.textContent = "";
      messageEl.className = "";
    };

    closeBtn.onclick = closeModal;
    overlay.onclick = closeModal;

    submitBtn.onclick = async () => {
      const email = emailInput.value.trim();
      
      if (!email) {
        showMessage("Please enter your email", true);
        return;
      }

      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showMessage("Please enter a valid email", true);
        return;
      }

      const variant = getCurrentVariant();
      if (!variant) {
        showMessage("Product variant not found", true);
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = "Subscribing...";

      try {
        const variantId = variant.id.toString().replace('gid://shopify/ProductVariant/', '');
        const inventoryItemId = variant.inventory_item_id ? variant.inventory_item_id.toString() : null;
        const currentPrice = variant.price ? (variant.price / 100).toFixed(2) : '0.00';
        
        const response = await fetch('/apps/notify-out-stock/proxy/subscribe', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: email,
            variantId: variantId,
            inventoryItemId: inventoryItemId,
            shop: shop,
            productName: productTitle,
            variantTitle: variant.title,
            productId: String(productId),
            currentPrice: currentPrice
          })
        });

        const contentType = response.headers.get("content-type");
        if (!contentType || !contentType.includes("application/json")) {
          const text = await response.text();
          console.error("Response body:", text);
          showMessage("Server error. Please try again.", true);
          return;
        }

        const data = await response.json();

        if (response.ok && data.success) {
          showMessage("‚úÖ Subscribed! We'll notify you when it's back.", false);
          emailInput.value = "";
          setTimeout(closeModal, 2000);
        } else {
          showMessage(data.message || data.error || "Failed. Please try again.", true);
        }
      } catch (error) {
        console.error("Subscription error:", error);
        showMessage("Network error. Please try again.", true);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = {{ block.settings.subscribe_text | json }};
      }
    };

    emailInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        submitBtn.click();
      }
    });
  }

  // ========== WISHLIST FUNCTIONALITY ==========
  if (wishlistBtn) {
    const wishlistIcon = wishlistBtn.querySelector('.wishlist-icon');
    const wishlistText = wishlistBtn.querySelector('.wishlist-text');
    
    // Check if product is already in wishlist
    async function checkWishlistStatus() {
      const customerEmail = "{{ customer.email }}";
      if (!customerEmail) return;

      try {
        const response = await fetch('/apps/notify-out-stock/proxy/wishlist/check', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: customerEmail,
            productId: String(productId),
            shop: shop
          })
        });

        const data = await response.json();
        if (data.inWishlist) {
          wishlistBtn.classList.add('in-wishlist');
          wishlistBtn.setAttribute('data-in-wishlist', 'true');
          wishlistIcon.textContent = 'üíö';
          wishlistText.textContent = 'In Wishlist';
        }
      } catch (error) {
        console.error("Check wishlist error:", error);
      }
    }

    // Add/Remove from wishlist
    wishlistBtn.onclick = async () => {
      let customerEmail = "{{ customer.email }}";
      
      // If not logged in, prompt for email
      if (!customerEmail) {
        customerEmail = prompt("Please enter your email to add to wishlist:");
        if (!customerEmail) return;
        
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(customerEmail)) {
          alert("Please enter a valid email address");
          return;
        }
      }

      const isInWishlist = wishlistBtn.getAttribute('data-in-wishlist') === 'true';
      const variant = getCurrentVariant();
      const variantId = variant.id.toString().replace('gid://shopify/ProductVariant/', '');
      const currentPrice = variant.price ? (variant.price / 100).toFixed(2) : '0.00';

      wishlistBtn.disabled = true;

      try {
        const endpoint = isInWishlist ? '/apps/notify-out-stock/proxy/wishlist/remove' : '/apps/notify-out-stock/proxy/wishlist/add';
        
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: customerEmail,
            productId: String(productId),
            variantId: variantId,
            productTitle: productTitle,
            variantTitle: variant.title,
            productImage: productImage,
            productHandle: productHandle,
            price: currentPrice,
            shop: shop
          })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          if (isInWishlist) {
            // Removed from wishlist
            wishlistBtn.classList.remove('in-wishlist');
            wishlistBtn.setAttribute('data-in-wishlist', 'false');
            wishlistIcon.textContent = '‚ù§Ô∏è';
            wishlistText.textContent = 'Add to Wishlist';
            alert('Removed from wishlist');
          } else {
            // Added to wishlist
            wishlistBtn.classList.add('in-wishlist');
            wishlistBtn.setAttribute('data-in-wishlist', 'true');
            wishlistIcon.textContent = 'üíö';
            wishlistText.textContent = 'In Wishlist';
            alert('Added to wishlist! ‚ù§Ô∏è');
          }
        } else {
          alert(data.message || data.error || 'Something went wrong');
        }
      } catch (error) {
        console.error("Wishlist error:", error);
        alert('Network error. Please try again.');
      } finally {
        wishlistBtn.disabled = false;
      }
    };

    // Check status on load
    checkWishlistStatus();
  }
})();
</script>

{% schema %}
{
  "name": "Notify Me + Wishlist",
  "target": "section",
  "settings": [
    { "type": "text", "id": "button_text", "label": "Notify Button Text", "default": "Notify me when available" },
    { "type": "text", "id": "headertext", "label": "Header Text", "default": "Get Notified" },
    { "type": "text", "id": "subheadertext", "label": "Subheader Text", "default": "Enter your email and we'll notify you when this product is back in stock." },
    { "type": "text", "id": "email_placeholder", "label": "Email Placeholder", "default": "Enter your email" },
    { "type": "text", "id": "subscribe_text", "label": "Subscribe Button Text", "default": "Notify Me" },
    { "type": "color", "id": "popup_bg_color", "label": "Popup Background Color", "default": "#ffffff" },
    { "type": "color", "id": "popup_text_color", "label": "Popup Text Color", "default": "#000000" },
    {
      "type": "select",
      "id": "popup_font",
      "label": "Popup Font Family",
      "default": "Inter, sans-serif",
      "options": [
        { "value": "Inter, sans-serif", "label": "Inter" },
        { "value": "Poppins, sans-serif", "label": "Poppins" },
        { "value": "Roboto, sans-serif", "label": "Roboto" },
        { "value": "Montserrat, sans-serif", "label": "Montserrat" }
      ]
    }
  ]
}
{% endschema %}