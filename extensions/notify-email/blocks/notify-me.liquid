{% if product.selected_or_first_available_variant.available == false %}
<style>
.product-form__buttons, .shopify-payment-button { display:none !important; }
#bis-btn { width:100%; padding:15px; background:black; color:white; cursor:pointer; border:none; }
#bis-modal { margin-top: 15px; }
</style>

<button id="bis-btn">Notify me when available</button>

<div id="bis-modal" style="display:none;">
  <input type="email" id="bis-email" placeholder="Enter your email" style="width:100%;padding:10px;margin-bottom:10px;">
  <button id="bis-submit" style="width:100%;padding:10px;background:green;color:white;border:none;cursor:pointer;">Submit</button>
  <p id="bis-message" style="margin-top:10px;"></p>
</div>

<script>
(function() {
  const btn = document.getElementById("bis-btn");
  const modal = document.getElementById("bis-modal");
  const submitBtn = document.getElementById("bis-submit");
  const emailInput = document.getElementById("bis-email");
  const message = document.getElementById("bis-message");

  btn.onclick = () => {
    modal.style.display = "block";
  };

  submitBtn.onclick = async () => {
    const email = emailInput.value.trim();
    
    if (!email || !email.includes("@")) {
      message.textContent = "Please enter a valid email";
      message.style.color = "red";
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = "Submitting...";
    message.textContent = "";

    try {
      const variantId = "{{ product.selected_or_first_available_variant.id }}";
      const shop = "{{ shop.permanent_domain }}";

      console.log("Sending:", { email, variantId, shop });

 const res = await fetch("/apps/notify-out-stock/subscribe", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    email: email,
    variantId: variantId,
    shop: shop
  })
});

      console.log("Response status:", res.status);
      
      const text = await res.text();
      console.log("Response text:", text);
      
      const data = text ? JSON.parse(text) : {};

      if (data.success) {
        message.textContent = "âœ“ You'll be notified when back in stock!";
        message.style.color = "green";
        emailInput.value = "";
        setTimeout(() => { modal.style.display = "none"; }, 2000);
      } else {
        message.textContent = "Error: " + (data.error || "Unknown error");
        message.style.color = "red";
      }
    } catch (err) {
      console.error("Fetch error:", err);
      message.textContent = "Network error. Please try again.";
      message.style.color = "red";
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "Submit";
    }
  };
})();
</script>
{% endif %}

{% schema %}
{
  "name": "Notify Me",
  "target": "section"
}
{% endschema %}