{% comment %}
  Only show notify button when product variant is OUT OF STOCK
  This condition checks if the selected variant is unavailable
{% endcomment %}
{% if product.selected_or_first_available_variant.available == false %}
<style>
.product-form__buttons, .shopify-payment-button { display:none !important; }
#bis-btn { 
  width:100%; 
  padding:15px; 
  background:black; 
  color:white; 
  cursor:pointer; 
  border:none; 
  border-radius: 5px; 
  font-size: 16px; 
  font-weight: bold;
  transition: background 0.3s;
}
#bis-btn:hover {
  background: #333;
}
#bis-btn:disabled {
  background: #ccc;
  cursor: not-allowed;
}
#bis-modal { 
  margin-top: 15px; 
  padding: 20px; 
  background: #f9f9f9; 
  border-radius: 5px; 
  border: 1px solid #ddd;
}
</style>

<button id="bis-btn" data-variant-id="{{ product.selected_or_first_available_variant.id }}">
  ðŸ”” Notify me when available
</button>

<div id="bis-modal" style="display:none;">
  <input 
    type="email" 
    id="bis-email" 
    placeholder="Enter your email" 
    style="width:100%;padding:12px;margin-bottom:10px;border:1px solid #ddd;border-radius:5px;"
    required
  >
  <button id="bis-submit" style="width:100%;padding:12px;background:#28a745;color:white;border:none;cursor:pointer;border-radius:5px;font-weight:bold;">
    Subscribe
  </button>
  <p id="bis-message" style="margin-top:10px;font-size:14px;"></p>
</div>

<script>
(function() {
  const btn = document.getElementById("bis-btn");
  const modal = document.getElementById("bis-modal");
  const submitBtn = document.getElementById("bis-submit");
  const emailInput = document.getElementById("bis-email");
  const message = document.getElementById("bis-message");
  const shop = "{{ shop.permanent_domain }}";
  const productName = "{{ product.title | escape }}";
  const productHandle = "{{ product.handle }}";
  
  // âœ… Store all variants with prices
  const allVariants = {{ product.variants | json }};

  // âœ… Listen for variant changes in the product form
  function updateVariantId() {
    const currentVariant = getCurrentVariant();
    if (currentVariant) {
      const variantId = currentVariant.id.toString().replace('gid://shopify/ProductVariant/', '');
      btn.setAttribute('data-variant-id', variantId);
      
      // âœ… IMPORTANT: Hide button if variant is IN STOCK
      if (currentVariant.available) {
        btn.style.display = 'none';
        modal.style.display = 'none';
        console.log("âœ… Variant IN STOCK - Button hidden");
      } else {
        btn.style.display = 'block';
        console.log("âš ï¸ Variant OUT OF STOCK - Button shown");
      }
      
      console.log("Variant changed to:", variantId, "Available:", currentVariant.available, "Price:", currentVariant.price);
    }
  }

  // âœ… Get current selected variant from Shopify's variant selector
  function getCurrentVariant() {
    // Method 1: Check URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const variantIdFromUrl = urlParams.get('variant');
    
    if (variantIdFromUrl) {
      const variant = allVariants.find(v => v.id.toString().includes(variantIdFromUrl));
      if (variant) return variant;
    }

    // Method 2: Check selected options in form
    const form = document.querySelector('form[action*="/cart/add"]');
    if (form) {
      const variantIdInput = form.querySelector('select[name="id"], input[name="id"]');
      if (variantIdInput && variantIdInput.value) {
        const variant = allVariants.find(v => 
          v.id.toString().includes(variantIdInput.value) || 
          v.id == variantIdInput.value
        );
        if (variant) return variant;
      }
    }

    // Method 3: Return first unavailable variant as fallback
    return {{ product.selected_or_first_available_variant | json }};
  }

  // âœ… Watch for variant changes
  document.addEventListener('DOMContentLoaded', () => {
    updateVariantId();

    // Listen to variant selector changes
    const variantSelectors = document.querySelectorAll('select[name="id"], input[name="id"], .product-form__input input, .product-form__input select');
    variantSelectors.forEach(selector => {
      selector.addEventListener('change', updateVariantId);
    });

    // Listen to URL changes (for variant links)
    if ('URLSearchParams' in window) {
      window.addEventListener('popstate', updateVariantId);
    }
  });

  // âœ… Show modal on button click
  btn.onclick = () => {
    modal.style.display = "block";
    message.textContent = "";
  };

  // âœ… Handle subscription
  submitBtn.onclick = async () => {
    const email = emailInput.value.trim();
    
    // Validate email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!email || !emailRegex.test(email)) {
      message.textContent = "âŒ Please enter a valid email address";
      message.style.color = "red";
      return;
    }

    // Get current variant
    const currentVariant = getCurrentVariant();
    if (!currentVariant) {
      message.textContent = "âŒ Could not detect variant. Please try again.";
      message.style.color = "red";
      return;
    }

    const variantId = currentVariant.id.toString().replace('gid://shopify/ProductVariant/', '');
    const inventoryItemId = currentVariant.inventory_item_id ? currentVariant.inventory_item_id.toString() : null;
    
    // âœ… CRITICAL: Get current price (convert from cents to dollars)
    const currentPrice = (currentVariant.price / 100).toFixed(2);
    
    submitBtn.disabled = true;
    submitBtn.textContent = "Subscribing...";
    message.textContent = "";

    try {
      console.log("Subscribing:", { 
        email, 
        variantId, 
        inventoryItemId,
        shop, 
        productName,
        currentPrice // âœ… Now included
      });

      const res = await fetch("/apps/notify-out-stock/proxy/subscribe", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          email: email,
          variantId: variantId,
          inventoryItemId: inventoryItemId, // âœ… Added
          shop: shop,
          productName: productName,
          currentPrice: currentPrice // âœ… CRITICAL for price drop alerts
        })
      });

      const text = await res.text();
      console.log("Response:", text);
      
      const data = text ? JSON.parse(text) : {};

      if (data.success) {
        message.textContent = "âœ… Subscribed! We'll email you when it's back in stock.";
        message.style.color = "green";
        emailInput.value = "";
        
        // Hide modal after 3 seconds
        setTimeout(() => { 
          modal.style.display = "none"; 
          message.textContent = "";
        }, 3000);
      } else {
        message.textContent = "âŒ " + (data.error || "Something went wrong. Please try again.");
        message.style.color = "red";
      }
    } catch (err) {
      console.error("Subscription error:", err);
      message.textContent = "âŒ Network error. Please try again.";
      message.style.color = "red";
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "Subscribe";
    }
  };

  // âœ… Allow Enter key to submit
  emailInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      submitBtn.click();
    }
  });
})();
</script>
{% endif %}

{% schema %}
{
  "name": "Notify Me",
  "target": "section",
  "settings": []
}
{% endschema %}